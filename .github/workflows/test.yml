# ì›Œí¬í”Œë¡œìš° ì´ë¦„: 1ë²ˆì§¸ ë‹¨ê³„ - í…ŒìŠ¤íŠ¸ ì‹¤í–‰
name: 1. Run Tests

# íŠ¸ë¦¬ê±° ì¡°ê±´: main ë¸Œëœì¹˜ì— pushë  ë•Œë§Œ ì‹¤í–‰ë©ë‹ˆë‹¤.
# paths ì¡°ê±´ì€ src ë””ë ‰í† ë¦¬ ë‚´ íŒŒì¼ì´ ë³€ê²½ë˜ì—ˆì„ ë•Œë§Œ ì›Œí¬í”Œë¡œìš°ê°€ ì‹¤í–‰ë¨ì„ ì˜ë¯¸í•©ë‹ˆë‹¤.
on:
  push:
    branches:
      - main  # main ë¸Œëœì¹˜ì— ëŒ€í•´ì„œë§Œ ì‹¤í–‰
    paths:
      - 'src/**'  # src ë””ë ‰í† ë¦¬ ë‚´ íŒŒì¼ì´ ë³€ê²½ë  ë•Œë§Œ ì‹¤í–‰

# GitHub Actionsì— í•„ìš”í•œ ê¶Œí•œ ì„¤ì •
permissions:
  checks: write
  contents: read

# ì‹¤í–‰í•  ì‘ì—…(job) ì •ì˜
jobs:
  # í…ŒìŠ¤íŠ¸ ì‘ì—… ì •ì˜
  test:
    # ì‹¤í–‰ í™˜ê²½: Ubuntu ìµœì‹  ë²„ì „
    runs-on: ubuntu-latest

    # ì‘ì—… ë‹¨ê³„(steps) ì •ì˜
    steps:
      # 1. ì½”ë“œ ê°€ì ¸ì˜¤ê¸°: GitHub ì €ì¥ì†Œì—ì„œ ì½”ë“œë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
      - name: Checkout repository
        uses: actions/checkout@v4  # ê³µì‹ checkout ì•¡ì…˜ v4 ë²„ì „ ì‚¬ìš©

      # 2. JDK ì„¤ì •: Java 17 ì„¤ì¹˜ (Spring Boot í”„ë¡œì íŠ¸ìš©)
      - name: Set up JDK 17
        uses: actions/setup-java@v3  # ê³µì‹ Java ì„¤ì • ì•¡ì…˜ v3 ë²„ì „ ì‚¬ìš©
        with:
          java-version: '17'  # Java ë²„ì „ ì§€ì •
          distribution: 'temurin'  # JDK ë°°í¬íŒ ì§€ì • (Eclipse Temurin)

      # 3. Gradle ìºì‹œ ì„¤ì •: ë¹Œë“œ ì†ë„ í–¥ìƒì„ ìœ„í•´ Gradle ì˜ì¡´ì„± ìºì‹±
      - name: Cache Gradle packages
        uses: actions/cache@v3  # ê³µì‹ ìºì‹œ ì•¡ì…˜ v3 ë²„ì „ ì‚¬ìš©
        with:
          path: |  # ìºì‹œí•  ê²½ë¡œ (ì—¬ëŸ¬ ì¤„ë¡œ í‘œí˜„)
            ~/.gradle/caches
            ~/.gradle/wrapper
          # ìºì‹œ í‚¤ ì„¤ì •: OSì™€ Gradle íŒŒì¼ í•´ì‹œê°’ ì¡°í•©ìœ¼ë¡œ ê³ ìœ  í‚¤ ìƒì„±
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          # ìºì‹œ ë³µì› í‚¤: ì •í™•íˆ ì¼ì¹˜í•˜ëŠ” ìºì‹œê°€ ì—†ì„ ë•Œ ì‚¬ìš©
          restore-keys: |
            ${{ runner.os }}-gradle-

      # 4. í…ŒìŠ¤íŠ¸ ì‹¤í–‰: Gradle í…ŒìŠ¤íŠ¸ ëª…ë ¹ ì‹¤í–‰
      - name: Run tests
        id: test_run
        run: chmod +x ./gradlew && ./gradlew test --scan  # gradlewì— ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬ í›„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        continue-on-error: true  # í…ŒìŠ¤íŠ¸ê°€ ì‹¤íŒ¨í•´ë„ ë‹¤ìŒ ë‹¨ê³„ë¡œ ì§„í–‰

      # 5. í…ŒìŠ¤íŠ¸ ê²°ê³¼ JUnit í˜•ì‹ìœ¼ë¡œ GitHub Actionsì— í‘œì‹œ
      - name: Publish Test Report (JUnit)
        uses: mikepenz/action-junit-report@v4
        if: always()  # í…ŒìŠ¤íŠ¸ ê²°ê³¼ì— ìƒê´€ì—†ì´ í•­ìƒ ì‹¤í–‰
        with:
          report_paths: '**/build/test-results/**/*.xml'
          detailed_summary: true  # ìƒì„¸ ìš”ì•½ í‘œì‹œ
          include_passed: true    # í†µê³¼í•œ í…ŒìŠ¤íŠ¸ë„ í‘œì‹œ
          check_name: 'í…ŒìŠ¤íŠ¸ ë¦¬í¬íŠ¸'
          fail_on_failure: false  # í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ì‹œì—ë„ ì›Œí¬í”Œë¡œìš°ëŠ” ê³„ì† ì§„í–‰

      # 6. í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì¶”ê°€ í‘œì‹œ (UI í–¥ìƒ)
      - name: Publish Test Results
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: always()  # í…ŒìŠ¤íŠ¸ ê²°ê³¼ì— ìƒê´€ì—†ì´ í•­ìƒ ì‹¤í–‰
        with:
          files: |
            **/build/test-results/**/*.xml
          report_individual_runs: true
          check_name: 'í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½'
          comment_mode: always
          compare_to_earlier_commit: true

      # 7. í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½ ê³„ì‚° ë° GitHub ì‘ì—… ìš”ì•½ì— í‘œì‹œ
      - name: Calculate Test Summary
        id: test_summary
        if: always()
        run: |
          TOTAL_TESTS=$(find . -path "*/build/test-results/*/*.xml" -type f -exec grep -l "<testcase" {} \; | xargs grep -h "<testcase" | wc -l || echo 0)
          FAILED_TESTS=$(find . -path "*/build/test-results/*/*.xml" -type f -exec grep -l "<failure" {} \; | xargs grep -h "<failure" | wc -l || echo 0)
          SKIPPED_TESTS=$(find . -path "*/build/test-results/*/*.xml" -type f -exec grep -l "<skipped" {} \; | xargs grep -h "<skipped" | wc -l || echo 0)
          SUCCESS_TESTS=$((TOTAL_TESTS - FAILED_TESTS - SKIPPED_TESTS))
          
          echo "total_tests=$TOTAL_TESTS" >> $GITHUB_OUTPUT
          echo "success_tests=$SUCCESS_TESTS" >> $GITHUB_OUTPUT
          echo "failed_tests=$FAILED_TESTS" >> $GITHUB_OUTPUT
          echo "skipped_tests=$SKIPPED_TESTS" >> $GITHUB_OUTPUT
          
          # í…ŒìŠ¤íŠ¸ ìƒíƒœ ê²°ì •
          if [ "$FAILED_TESTS" -gt 0 ]; then
            echo "Test completed with failures: $FAILED_TESTS failed, $SUCCESS_TESTS succeeded, $SKIPPED_TESTS skipped out of $TOTAL_TESTS total tests" > test_status.txt
            echo "status=failed" >> $GITHUB_OUTPUT
          else
            echo "Test completed successfully: $SUCCESS_TESTS succeeded, $SKIPPED_TESTS skipped out of $TOTAL_TESTS total tests" > test_status.txt
            echo "status=success" >> $GITHUB_OUTPUT
          fi
          
          # GitHub ì‘ì—… ìš”ì•½ì— í…ŒìŠ¤íŠ¸ ê²°ê³¼ í‘œì‹œ
          echo "## ğŸ§ª í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| ì¹´í…Œê³ ë¦¬ | ìˆ˜ëŸ‰ | ìƒíƒœ |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| ì´ í…ŒìŠ¤íŠ¸ | $TOTAL_TESTS | - |" >> $GITHUB_STEP_SUMMARY
          
          if [ "$SUCCESS_TESTS" -gt 0 ]; then
            SUCCESS_PERCENT=$(echo "scale=2; ($SUCCESS_TESTS / $TOTAL_TESTS) * 100" | bc -l)
            echo "| ì„±ê³µ | $SUCCESS_TESTS | âœ… ($SUCCESS_PERCENT%) |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ì„±ê³µ | 0 | âœ… (0%) |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "$FAILED_TESTS" -gt 0 ]; then
            FAILED_PERCENT=$(echo "scale=2; ($FAILED_TESTS / $TOTAL_TESTS) * 100" | bc -l)
            echo "| ì‹¤íŒ¨ | $FAILED_TESTS | âŒ ($FAILED_PERCENT%) |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ì‹¤íŒ¨ | 0 | âŒ (0%) |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "$SKIPPED_TESTS" -gt 0 ]; then
            SKIPPED_PERCENT=$(echo "scale=2; ($SKIPPED_TESTS / $TOTAL_TESTS) * 100" | bc -l)
            echo "| ìŠ¤í‚µ | $SKIPPED_TESTS | â­ï¸ ($SKIPPED_PERCENT%) |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ìŠ¤í‚µ | 0 | â­ï¸ (0%) |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "$FAILED_TESTS" -gt 0 ]; then
            echo "### âŒ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨" >> $GITHUB_STEP_SUMMARY
            echo "í…ŒìŠ¤íŠ¸ $FAILED_TESTSê°œê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìì„¸í•œ ë‚´ìš©ì€ ì•„ë˜ í…ŒìŠ¤íŠ¸ ë³´ê³ ì„œë¥¼ í™•ì¸í•˜ì„¸ìš”." >> $GITHUB_STEP_SUMMARY
          else
            echo "### âœ… ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³¼" >> $GITHUB_STEP_SUMMARY
            echo "ëª¨ë“  í…ŒìŠ¤íŠ¸ê°€ ì„±ê³µì ìœ¼ë¡œ í†µê³¼í–ˆìŠµë‹ˆë‹¤!" >> $GITHUB_STEP_SUMMARY
          fi
          
          cat test_status.txt

      # 8. HTML í…ŒìŠ¤íŠ¸ ë³´ê³ ì„œ ìƒì„± ë° ë¦¬í¬ì§€í† ë¦¬ì— í‘œì‹œ
      - name: Generate HTML Test Report
        if: always()
        run: |
          mkdir -p test-reports
          
          # HTML í…ŒìŠ¤íŠ¸ ë³´ê³ ì„œ í—¤ë” ìƒì„±
          cat << EOF > test-reports/test-summary.html
          <!DOCTYPE html>
          <html lang="ko">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½</title>
            <style>
              body { font-family: 'Noto Sans KR', sans-serif; margin: 0; padding: 20px; color: #333; }
              .container { max-width: 800px; margin: 0 auto; background: #fff; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); padding: 20px; }
              h1 { color: #2c3e50; text-align: center; margin-bottom: 30px; }
              .summary { display: flex; justify-content: space-around; margin-bottom: 30px; text-align: center; }
              .summary-item { flex: 1; padding: 15px; }
              .summary-item .number { font-size: 24px; font-weight: bold; margin-bottom: 5px; }
              .success { color: #27ae60; }
              .failure { color: #e74c3c; }
              .skipped { color: #f39c12; }
              .status { text-align: center; padding: 15px; margin: 20px 0; border-radius: 4px; font-weight: bold; }
              .status.success { background-color: #d5f5e3; }
              .status.failure { background-color: #fadbd8; }
              .footer { text-align: center; margin-top: 30px; font-size: 12px; color: #7f8c8d; }
            </style>
          </head>
          <body>
            <div class="container">
              <h1>ğŸ§ª í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½</h1>
              <div class="summary">
                <div class="summary-item">
                  <div class="number">${{ steps.test_summary.outputs.total_tests }}</div>
                  <div>ì´ í…ŒìŠ¤íŠ¸</div>
                </div>
                <div class="summary-item">
                  <div class="number success">${{ steps.test_summary.outputs.success_tests }} âœ…</div>
                  <div>ì„±ê³µ</div>
                </div>
                <div class="summary-item">
                  <div class="number failure">${{ steps.test_summary.outputs.failed_tests }} âŒ</div>
                  <div>ì‹¤íŒ¨</div>
                </div>
                <div class="summary-item">
                  <div class="number skipped">${{ steps.test_summary.outputs.skipped_tests }} â­ï¸</div>
                  <div>ìŠ¤í‚µ</div>
                </div>
              </div>
          
              <div class="status ${{ steps.test_summary.outputs.status == 'success' && 'success' || 'failure' }}">
                í…ŒìŠ¤íŠ¸ ê²°ê³¼: ${{ steps.test_summary.outputs.status == 'success' && 'âœ… ì„±ê³µ' || 'âŒ ì‹¤íŒ¨' }}
              </div>
          
              <div class="footer">
                ì‹¤í–‰ ì‹œê°„: $(date)
                <br>
                ì´ ë³´ê³ ì„œëŠ” GitHub Actionsì—ì„œ ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.
              </div>
            </div>
          </body>
          </html>
          EOF
          
          # ë§ˆí¬ë‹¤ìš´ ìš”ì•½ ë³´ê³ ì„œë„ ìƒì„±
          cat << EOF > test-reports/test-summary.md
          # í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½
          
          ## í†µê³„
          - ì´ í…ŒìŠ¤íŠ¸ ìˆ˜: ${{ steps.test_summary.outputs.total_tests }}
          - ì„±ê³µ: ${{ steps.test_summary.outputs.success_tests }} âœ…
          - ì‹¤íŒ¨: ${{ steps.test_summary.outputs.failed_tests }} âŒ
          - ìŠ¤í‚µ: ${{ steps.test_summary.outputs.skipped_tests }} â­ï¸
          
          ## ìƒíƒœ
          - í…ŒìŠ¤íŠ¸ ê²°ê³¼: ${{ steps.test_summary.outputs.status == 'success' && 'âœ… ì„±ê³µ' || 'âŒ ì‹¤íŒ¨' }}
          
          *ì´ ë³´ê³ ì„œëŠ” ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*
          EOF

      # 9. í…ŒìŠ¤íŠ¸ ë³´ê³ ì„œ ì•„í‹°íŒ©íŠ¸ë¡œ ì—…ë¡œë“œ
      - name: Upload Test Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: |
            test-reports/
            **/build/reports/tests/
          retention-days: 1  # ë³´ê³ ì„œë¥¼ 1ì¼ê°„ ë³´ê´€

      # 10. í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ: ë‹¤ë¥¸ ì›Œí¬í”Œë¡œìš°ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ê²°ê³¼ ì €ì¥
      - name: Upload Test Status
        if: always()  # í•­ìƒ í…ŒìŠ¤íŠ¸ ìƒíƒœ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4  # ê³µì‹ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ ì•¡ì…˜ v4 ë²„ì „ ì‚¬ìš©
        with:
          name: test-status  # ì•„í‹°íŒ©íŠ¸ ì´ë¦„
          path: test_status.txt  # ì—…ë¡œë“œí•  íŒŒì¼ ê²½ë¡œ
          retention-days: 7  # ì•„í‹°íŒ©íŠ¸ ë³´ê´€ ê¸°ê°„(ì¼)